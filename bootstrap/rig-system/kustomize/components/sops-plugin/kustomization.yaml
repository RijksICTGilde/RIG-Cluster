apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
- ../../configmap-sops-plugin.yaml

patches:
- target:
    kind: ArgoCD
  patch: |-
    - op: replace
      path: /spec/repo
      value:
        serviceaccount: argocd-argocd-server
        volumes:
          - name: cmp-plugin
            configMap:
              name: cmp-plugin
          - name: cmp-tmp
            emptyDir: {}
          - name: kube-api-access
            projected:
              sources:
                - serviceAccountToken:
                    path: token
                - configMap:
                    name: kube-root-ca.crt
                    items:
                      - key: ca.crt
                        path: ca.crt
                - downwardAPI:
                    items:
                      - path: namespace
                        fieldRef:
                          fieldPath: metadata.namespace
        sidecarContainers:
          - name: cmp-server
            image: rig-cmp-argo-kustomize-sops:latest
            imagePullPolicy: Always
            command: ["/var/run/argocd/argocd-cmp-server"]
            env:
              - name: KUSTOMIZE_PLUGIN_HOME
                value: /etc/kustomize/plugin
            securityContext:
              runAsNonRoot: true
              runAsUser: 999
            volumeMounts:
              - name: var-files
                mountPath: /var/run/argocd
              - name: plugins
                mountPath: /home/argocd/cmp-server/plugins
              - name: cmp-plugin
                mountPath: /home/argocd/cmp-server/config
              - name: cmp-tmp
                mountPath: /tmp
              - name: kube-api-access
                mountPath: /var/run/secrets/kubernetes.io/serviceaccount
                readOnly: true