apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

patches:
  - target:
      kind: PersistentVolumeClaim
      name: pgadmin
    patch: |-
      - op: replace
        path: /spec/storageClassName
        value: ocs-storagecluster-ceph-rbd
  - target:
      kind: Deployment
      name: pgadmin
    patch: |-
      # TODO: pgadmin does not work yet in openshift, so we scale to 0 to fix later
      - op: replace
        path: /spec/replicas
        value: 0
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 5050
          runAsGroup: 5050
          fsGroup: 5050
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
            add:
              - NET_BIND_SERVICE
          readOnlyRootFilesystem: false
  - target:
      kind: Ingress
      name: pgadmin
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: pgadmin.rig.prd1.gn2.quattro.rijksapps.nl